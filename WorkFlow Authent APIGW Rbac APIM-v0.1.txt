@startuml
title Publication et appel d'une API avec CI/CD + IaC + APIM + Gateway + DNS + Firewall + OAuth2 complet

actor Dev as Developer
participant "Repo Git\n(Code + IaC)" as Git
participant "CI/CD Pipeline" as CICD
participant "IaC Engine\n(Terraform/Bicep)" as IaC
participant "DNS" as DNS
participant "Firewall\n(WAF / NSG / SG)" as FW
participant "API Gateway" as APIGW
participant "APIM\n(API Management)" as APIM
participant "Authorization Server\n(OAuth2 / OIDC)" as AS
participant "JWKS Endpoint" as JWKS
participant "Introspection Endpoint" as INTROSPECT
participant "Backend API\n(Resource Server)" as Backend
participant "User Right" as RBAC
participant "Client" as Client
actor User as User

== Phase 1 : Build & Deploy Backend ==
Developer -> Git : Push code API + IaC
Git -> CICD : Webhook déclenche pipeline

CICD -> CICD : Build + Tests
CICD -> Backend : Déploiement backend (K8s/App Service/Container)
Backend --> CICD : URL interne exposée

== Phase 2 : Provisioning Infra via IaC ==
CICD -> IaC : Lancer IaC (plan/apply)

IaC -> DNS : Créer/MAJ enregistrement DNS\n(api.mondomaine.tld -> API Gateway)
IaC -> FW : Ouvrir flux nécessaires\n(Client -> APIGW, APIGW -> Backend)
IaC -> APIGW : Créer route /api/v1 -> Backend
IaC -> APIM : Créer API + policies\n(Auth, RBAC, quotas, logs)

== Phase 3 : Obtention du token OAuth2 ==
Client -> AS : POST /token (client_credentials / auth_code)
AS -> JWKS : Récupération clé publique pour signer token
JWKS --> AS : JWKS (clé publique)
AS --> Client : Access Token (JWT)

== Phase 4 : Appel API ==
Client -> APIGW : GET /api/v1/resource\nAuthorization: Bearer <JWT>

== Authentification API Gateway ==
APIGW -> JWKS : Récupérer clé publique (cacheable)
JWKS --> APIGW : JWKS
APIGW -> APIGW : Vérification signature JWT
APIGW -> APIGW : Vérification scopes techniques


== Passage vers APIM ==
APIGW -> APIM : Appel routé + JWT

== Vérification APIM ==
APIM -> INTROSPECT : POST /introspect <JWT>
INTROSPECT --> APIM : statut + claims

APIM -> RBAC : Vérification rôles utilisateur\n(role=data-reader)
RBAC --> APIM : Permissions

APIM -> APIM : Policies (RBAC, quotas, IP filtering, CORS)


== Appel Backend ==
APIM -> Backend : Appel API backend\n(token propagé ou token interne)
Backend --> APIM : Réponse

== Retour au client ==
APIM --> APIGW : Réponse filtrée / transformée
APIGW --> Client : Réponse finale

@enduml
